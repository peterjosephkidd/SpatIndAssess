---
title: "ESIA for 10 Data Rich Stocks"
author: "Peter Kidd"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    toc: true
    toc_float: true
    toc_collapsed: false
    number_section: true
    theme: journal
    highlight: zenburn
    df_print: paged
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, echo = TRUE, fig.align = "center", fig.width = 6, comment = ">", cache = F)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Prepare Workspace
```{r wd}
# rm(list = ls())
getwd()

getOption("download.file.method") # if wininet, change to auto 
options(download.file.method = "curl")
```

# Load packages
```{r load.packages, message = FALSE}
# Install FLR packages
#remotes::install_github("flr/FLCore")
#remotes::install_github("flr/FLBRP")

# load packages
pckgs <- c("FLCore", "FLBRP", "dplyr", "ggplot2", "ggplotFL", "rgdal", "DataExplorer", "rgeos", "sf", "mapplots", "maptools", "mapproj", "beepr", "patchwork", "ineq", "icesDatras", "icesVocab", "scales", "readxl", "data.table", "zoo")

for(pkg in pckgs){
  library(pkg, character.only = T, quietly = T)
}

rm(pckgs, pkg)
```


# Source user functions
```{r funs, cache = F}
source(paste0(getwd(), "/Functions/dataprep_funs.R")) # for dealing with datras data
source(paste0(getwd(), "/Functions/spatinds_funs.R")) # for computing spatial indicators
source(paste0(getwd(), "/Functions/ROC_funs.R"))      # for ROC and TSS
```

# Load in Data
## ICES Divisions and Rectangles 
```{r ices.rect, cache = T}
### ICES Rectangles
#ices_rect2 <- readOGR(dsn = paste0(getwd(), "/Data/ICES Rect"), layer = "StatRec_map_Areas_Full_20170124")
#ices_rect <- makeReadableFortify(ices_rect2)
#rm(ices_rect2)

### ICES Divisions
#ices_divs2 <- readOGR(dsn = paste0(getwd(), "/Data/ICES Divs"), layer = "ICES_Areas_20160601_cut_dense_3857")
# ices_divs <- readOGR(dsn = "ICES North Sea Divisions", layer = "ICES_Divisons_CodHadWhgPok") # old shapefile
#ices_divs <- makeReadableFortify(ices_divs2)
#rm(ices_divs2)
```
```{r}
load(paste0(getwd(), "/Data/ICES Rect/ices_rect.rds"))
load(paste0(getwd(), "/Data/ICES Divs/ices_divs.rds"))
```


### Plot Divisions (FIX)
!! The x y coordinates of the shapefiles are currently on different scales and cannot be overlapped using the method with the old ICES Divisions shapefile
```{r}
### Check that divisions and rectangles look appropriate
ggplot() +
    geom_path(data = ices_divs, mapping = aes(x = long, y = lat, group = group), colour = "black") +
    geom_tile(data = ices_rect, mapping = aes(x = stat_x, y = stat_y, fill = Area_27)) +
    #geom_path(data = ices_divs, mapping = aes(x = long, y = lat, group = group), colour = "black") +
    #coord_cartesian(xlim = c(-50, 50), ylim = c(30,65), expand = F) +
    # World map
    borders("world", fill = "grey", colour = "black")
```


## Survey Data
Load in the survey data previously downloaded and processed in `1_Download_Survey_Data.Rmd`. These files are too large to upload to GitHub, so run the code and save to local drive. Change `surveydata.path` to the file locations: 
```{r}
surveydata.path <- "C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/Survey Data/"

# We don't need to load these in for now
#load(paste0(surveydata.path, "NS-IBTS/ns_ibts.data.rda"))   # NS-IBTS
#load(paste0(surveydata.path, "BTS/bts.data.rda"))           # BTS
#load(paste0(surveydata.path, "BTS-Isis/bts_isis.data.rda")) # BTS-Isis
#load(paste0(surveydata.path, "UK-BTS/uk_bts.data.rda"))     # UK-BTS
#load(paste0(surveydata.path, "DYFS/dyfs.data.rda"))         # DYFS
#load(paste0(surveydata.path, "FR-CGFS/fr_cgfs.data.rda"))   # FR-CGFS
#load(paste0(surveydata.path, "IE-IGFS/ie_igfs.data.rda"))   # IE-IGFS
#load(paste0(surveydata.path, "SCOWCGFS/scowcgfs.data.rda")) # SCOWCGFS
#load(paste0(surveydata.path, "SNS/sns.data.rda"))           # SNS
#load(paste0(surveydata.path, "SWC-IBTS/swc_ibts.data.rda")) # SWC-IBTS
```

## Stock Objects
Load in the stock assessment objects:
```{r}
stockobj.path <- paste0(getwd(), "/Data/DR_Stocks/Stock Objects/2022/")
for(stockfile in list.files(stockobj.path)){
  load(paste0(stockobj.path, stockfile))
}
```

## Stock Metadata and Reference Points
I have manually taken information from the advice sheets and put it into a Excel document
```{r}
allstk_metadata <- read_excel(paste0(getwd(), "/Data/DR_Stocks/Advice Sheets/2022/stock_metadata_refpts.xlsx"), sheet = "stk_metadata")
allstk_refpts <- read_excel(paste0(getwd(), "/Data/DR_Stocks/Advice Sheets/2022/stock_metadata_refpts.xlsx"), sheet = "stk_refpts")
```

# Run
## Set Parameters
### Choose Stock
Change `stk` and `stk.chr` to the stock you want to run the ROC analysis for.
```{r set.stock}
### Stocks available
unique(allstk_metadata$stk_id) # ignore so.27.7d for now, need to find YFS survey data
### Select the stock to analyse
stk <- cod.27.47d20_nov
stk.chr <- "cod.27.47d20_nov"
```

### Species Name
```{r get.spcsname}
### Get the stock species name
species <- allstk_refpts %>% filter(
  stk_name == stk.chr) %>%
  select(spcs_name, latin_name)
head(species)

### Get Valid Aphia ID using Latin name
species_aphia <- findAphia(species$latin_name, latin = TRUE)
```

### Stock Divisions
```{r get.stkdivs}
### Get the ICES divisions for the stock of interest
stk_divs2 <- allstk_metadata %>% filter(
  stk_id == stk.chr) %>%
  select(stk_divs) %>%
  unique()
stk_divs <- strsplit(as.character(stk_divs2), split = ", ")[[1]]
rm(stk_divs2)

print(paste0("ICES Divisions for ", species$spcs_name, " (", stk.chr, ") :"))
print(stk_divs)

### check stk_divs are in the ices_rect and ices_divs
stk_divs %in% ices_rect$Area_27
stk_divs %in% ices_divs$Area_27
```


### Stock Reference Points
```{r get.stkrefpts}
### Get the advice sheet reference points for the stock
stk_refpts <- allstk_refpts %>% filter(
  stk_name == stk.chr)
print(stk_refpts)
```

## Survey Information
These are the surveys that were used in the most recent assessment and mentioned on the ICES advice sheets for the corresponding stock. Most stocks have more than survey index incorperated within the stock assessment. Each individual survey index can also use multiple sources of survey data. E.g. a Q3 survey index might use and combine data from NS-IBTS Q3 and BTS Q3.

### `stk_surveys`
```{r get.surveyinfo}
### Get survey information for the current stock we are looking at
stk_surveys <- allstk_metadata %>% filter(
  stk_id == stk.chr) %>%
  select(-description, -date_published)
print(stk_surveys)
```
### `data.list`
There are many survey indices used, each using survey data from different year ranges and different quarters. In the spatial indicator analysis we will try to use the exact same range of survey data that was used in the stock assessments for each stock. This will ensure that the survey data used in the spatial analysis matches the data used in the stock assessment.
```{r}
### Select the surveys used within the stock assessment
## we will load in the survey data from local drive 
surveydata.path <- "C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/Survey Data/"

## Load the survey data used in the stock assessment for the current stock we are looking at
## Store in a list so we can loop through it later
## e.g. for Witch, BTS and NS-IBTS survey data were used. We store all this survey data into a list.
## we will filter this survey data to the correct years and quarters for each survey index later
## e.g. witch has 3 survey indices, BTS Q3, IBTS Q1, IBTS Q3, with different year ranges
data.list <- list()
for(survey in unique(stk_surveys$survey_name)){
  survey_data <- list.files(paste0(surveydata.path, survey), pattern = "*.data.rds*")
  survey_data <- try(load(paste0(surveydata.path, survey, "/", survey_data)))
  survey_data <- try(get(survey_data))
  data.list[[survey]] <- survey_data
}

### Check that surveys loaded are what we expect
summary(data.list)
row.names(summary(data.list)) %in% unique(stk_surveys$survey_name) # should be TRUE
```
Each survey within `data.list` contains the `hh`, `hl`, `ca` and combined `hlhh` data that was constructed in the data processing using `prepsurveydata`. We will mostly be working with the `hlhh` data but the rest is there for convenience.

### `stk_surveys_indices` (might not need)
Some surveys are combined to form one index as previously mentioned (e.g. IBTS Q3 and BTS Q3 might be combined to form a Q3 Survey Index)
```{r}
### Get the name of the individual indexes used in the stock assessment
### Each index can be comprised of multiple survey data sources 
### Get the name of the survey indices used in the stock assessment:
stk_surveys_indices <- allstk_metadata %>% filter(
  stk_id == stk.chr) %>%
  select(survey_index) %>%
  unique()
print(stk_surveys_indices)
```
### `stk_data_filtered`
We will now filter the survey data in accordance to the data used within each survey index. Sometimes the exact date ranges of survey data is not given in the stock assessment advice sheets. I have made the assumption that where the end year of the survey data used is not given, data up to the most recent data is used. Similarly, if the start year of survey data used is not given, data is used from the beginning of the survey data time series i.e. when the survey began. This latter assumption will need to be double checked as often older survey data is omitted due to differences in sampling effort or design compared to the most recent data.
```{r}
### Get the survey data used in each index and filter it so that it matches
### the data used in the stock assessment e.g. by Species, Years, and Quarters. 
stk_data_filtered <- list()
for(indx in stk_surveys_indices$survey_index){
  # for each survey index in the stock assessment...
  print(paste0("Survey Index: ", indx))
  # get the row of data in allstk_metadata for this survey index
  stkindx_surveys <- allstk_metadata %>%
  filter(stk_id == stk.chr,
         survey_index == indx)
  print(stkindx_surveys)
  #stk_data_filtered[indx] <- indx
  
  for(survey in stkindx_surveys$survey_name){
    print(paste0("Survey: ", survey))
    # for each survey within each survey index...
    # get the start and end years of the survey data used
    yr_strt <- stkindx_surveys$survey_yrs_start[stkindx_surveys$survey_name==survey]
    yr_end <- stkindx_surveys$survey_yrs_end[stkindx_surveys$survey_name==survey] 
    # assumptions made if start or end year is not given in the stock assessment
    if(is.na(yr_end)==TRUE){yr_end <- 2022} # assume most recent data used
    if(is.na(yr_strt)==TRUE){yr_strt <- 1900} # assume oldest data used
    # get the quarters used in stock stock index for this survey
    qrs <- stkindx_surveys$survey_qrs[stkindx_surveys$survey_name==survey]

    # sometimes the quarters used is not available in the advice sheets, so 
    # assume all quarters were used. This isn't explicitly stated probably because some 
    # surveys are only run in certain quarters so there is no need to say.
    # Setting `qrs` to c(1:4) will retain whatever data the survey has. 
    if(is.na(qrs)){
      qrs <- c(1:4)
    }
    
    # filter the years and quarters of survey data, for each survey, within each survey index
    # CHECK: do I need to do c(qrs). Will this code work if there are multiple quartes that need to be selected
    hlhh <- try(data.list[[survey]]$hlhh %>%
      filter(Year %in% c(yr_strt:yr_end),
             Quarter %in% qrs)) 
    hl <- try(data.list[[survey]]$hl %>%
      filter(Year %in% c(yr_strt:yr_end),
             Quarter %in% qrs))
    hh <- try(data.list[[survey]]$hh %>%
      filter(Year %in% c(yr_strt:yr_end),
             Quarter %in% qrs))
    ca <- try(data.list[[survey]]$ca %>%
      filter(Year %in% c(yr_strt:yr_end),
             Quarter %in% qrs))
    
    stk_data_filtered[[indx]][[survey]] <- list(hlhh = hlhh, hl = hl, hh = hh, ca = ca)
  }
}
```

Check that `stk_filtered_data` has been filtered to what we expect from the excel spreadsheet we imported and filtered earlier (`stk_surveys`)
```{r}
### Check data has been filtered to the correct index, survey, years, and quarters
for(indx in 1:length(stk_data_filtered)){
  # get survey index name from data
  message(paste0("Survey Index:             ", names(stk_data_filtered[indx])))
  # does this match with the excel doc
  print(noquote(paste0("Survey index matches? ", names(stk_data_filtered[indx]) %in% stk_surveys$survey_index)))
  for(survey in 1:length(stk_data_filtered[[indx]])){
    # get survey name within this survey index
    print(noquote(paste0("  Survey:             ", names(stk_data_filtered[[indx]][survey]))))
    # does this survey match with exceld doc
    print(noquote(paste0("  Survey matches?     ", names(stk_data_filtered[[indx]][survey]) ==
                           stk_surveys[stk_surveys$survey_index==names(stk_data_filtered[indx]) & 
                           stk_surveys$survey_name==names(stk_data_filtered[[indx]][survey]), "survey_name"])))
    # get survey data years from the dataset
    print(noquote(paste0("  Survey years:       ", min(stk_data_filtered[[indx]][[survey]]$hlhh$Year), "-", max(stk_data_filtered[[indx]][[survey]]$hlhh$Year))))
    # does this match with the start and end years in the excel doc
    print(noquote(paste0("  Start year matches? ", 
                         min(stk_data_filtered[[indx]][[survey]]$hlhh$Year) == 
                           stk_surveys[stk_surveys$survey_index==names(stk_data_filtered[indx]) & 
                           stk_surveys$survey_name==names(stk_data_filtered[[indx]][survey]), "survey_yrs_start"])))
    print(noquote(paste0("  End year matches?   ", 
                         max(stk_data_filtered[[indx]][[survey]]$hlhh$Year) == 
                           stk_surveys[stk_surveys$survey_index==names(stk_data_filtered[indx]) & 
                           stk_surveys$survey_name==names(stk_data_filtered[[indx]][survey]), "survey_yrs_end"])))
    # get survey quarters from the dataset
    print(noquote(paste0("  Survey quarters:    ", unique(stk_data_filtered[[indx]][[survey]]$hlhh$Quarter))))
    # does this match with the survey quarters in the excel doc
    print(noquote(paste0("  Quarters match?     ", 
                         unique(stk_data_filtered[[indx]][[survey]]$hlhh$Quarter) == 
                           stk_surveys[stk_surveys$survey_index==names(stk_data_filtered[indx]) & 
                           stk_surveys$survey_name==names(stk_data_filtered[[indx]][survey]), "survey_qrs"])))
    print(noquote("---------------------------"))
  }
}
```


## Calculate Spatial Indicators
Here we calculate time-series of spatial indicators and plot this time series. This will be done for each individual survey within each survey index. We will be using the `stk-filtered-data` so that we are calculating spatial indicators using he same years and quarters of survey data that are used within the ICES stock assessments. 
```{r}
### Output path to save data and plots
## Keeping this to my one drive, files may be too large for GitHub
si.output.path <- "C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/10Stock_Outputs/"

### Calculate spatial indicators for every year in each individual time series of survey data
indx <- "UK-BTS"
survey <- "UK-BTS"
for(indx in 1:length(stk_data_filtered)){
  for(survey in 1:length(stk_data_filtered[[indx]])){
    # get survey name within this survey index
    message("---------------------------\n", names(stk_data_filtered[indx]))
    writeLines(noquote(paste0("Survey Index:       ", names(stk_data_filtered[indx]))))
    writeLines(noquote(paste0("Survey:             ", names(stk_data_filtered[[indx]][survey]))))
    # get filtered survey data
    hlhh <- stk_data_filtered[[indx]][[survey]]$hlhh
    hh <- stk_data_filtered[[indx]][[survey]]$hh
    yrs <- unique(hlhh$Year)[unique(hlhh$Year) < 2022] # make sure max does not exceed max year in 2022 stock assessment 
    qrs <- unique(hlhh$Quarter)
    writeLines(noquote(paste0("Survey years:       ", min(yrs), "-", max(yrs))))
    writeLines(noquote(paste0("Survey quarters:    ", paste(sort(unique(qrs)), collapse = ", "))))
    
    ### Calculate spatial indicators for each survey
    message("\nCalculating spatial indicators")
    ### Positive Area (by ICES rectangle)
    writeLines(noquote("Positive Area (Rectangle)"))
    np.rects <- pa_rect( 
            hlhh = hlhh, 
            yrs = yrs, 
            qrs = qrs, 
            species_aphia = species_aphia, 
            stk_divs = stk_divs)

    ### Positive Area (by Haul)
    writeLines(noquote("Positive Area (Haul)"))
    np.hauls <- pa_haul(
            hlhh = hlhh, 
            yrs = yrs, 
            qrs = qrs, 
            species_aphia = species_aphia, 
            stk_divs = stk_divs)
    
    ### Lorenz curve data
    writeLines(noquote("Lorenz Curve"))
    lorenz <- lorenz_data(hlhh = hlhh, 
            yrs = yrs, 
            qrs = qrs, 
            species_aphia = species_aphia, 
            stk_divs = stk_divs)
    
    #### Gini index
    writeLines(noquote("Gini Index"))
    Gini.index <- Gini(lorenz)

    #### D95
    writeLines(noquote("D95"))
    D95 <- d95(lorenz)
    
    ### Spread of Participation Index (SPI)
    #### Prep data
    writeLines(noquote("Spread of Participation Index"))
    #spi_data <- spi_prep(hlhh = hlhh, 
    #        yrs = yrs, 
    #        qrs = qrs, 
    #        species_aphia = species_aphia, 
    #        stk_divs = stk_divs)
    #### Calculate
    #spi <- spi_data %>% 
    #  group_by(Year) %>% # Year only, not quarter
    #  filter(Area_27 %in% stk_divs) %>%
    #  summarise(SPI = spi_calc(TotalNo_TotalDur, area = 1)) %>% # area=1 = all rects equal weight
    #  mutate(Quarter = paste(as.character(sort(unique(spi_data$Quarter))), collapse = ", ")) %>% # add quarters
    #  relocate(Year, Quarter)
    #### Take inverse of SPI, so high numbers = good
    #spi$SPI <- 1-spi$SPI 
    #### Then change NaNs to 0
    #spi$SPI[is.nan(spi$SPI)] <- 0 
    SPI <- spi(
      hlhh = hlhh,
      yrs = yrs,
      qrs = qrs,
      species_aphia = species_aphia,
      stk_divs = stk_divs
    )
    
    ### Spreading Area
    writeLines(noquote("Spreading Area"))
    sa_data <- spreadingarea_data(
      hlhh = hlhh,
      yrs = c(yrs),
      qrs = c(qrs),
      species_aphia = species_aphia,
      stk_divs = stk_divs)
    sa <- sa_data %>%
      group_by(Year) %>%
      summarise("Spreading Area" = spreadingarea_calc(TotalNo_Dur)) %>%
      mutate(Quarter = paste(as.character(sort(unique(sa_data$Quarter))), collapse = ", ")) %>% # add quarters
      relocate(Year, Quarter)
    
    ### Equivalent Area 
    writeLines(noquote("Equivalent Area"))
    ea <- sa_data %>%
      group_by(Year) %>%
      summarise("Equivalent Area" = equivalentarea(TotalNo_Dur)) %>%
      mutate(Quarter = paste(as.character(sort(unique(sa_data$Quarter))), collapse = ", ")) %>% # add quarters
      relocate(Year, Quarter)
    
    ### Centre of Gravity, Inertia, & 95% CI Ellipse
    writeLines(noquote("Centre of Gravity (x and y)"))
    writeLines(noquote("Inertia"))
    writeLines(noquote("95% CI Ellipse"))

    cog <- coginert(
      hlhh = hlhh,
      yrs = yrs,
      qrs = qrs,
      species_aphia = species_aphia,
      stk_divs = stk_divs)


    ### Convex Hull Area
    writeLines(noquote("Convex Hull Area"))
    cha <- chullarea(
      hlhh = hlhh,
      yrs = yrs,
      qrs = qrs,
      species_aphia = species_aphia,
      stk_divs = stk_divs)
    
      
################################################################################
    ### Merge all spatial indicator values into a single data frame
    message("\nMerging and saving spatial indicator data...")
    ## select the columns that we need
    Gini.index <- Gini.index[c("Year", "Quarter", "Gini Index")]
    D95 <- D95[c("Year", "Quarter", "D95")]
    np.hauls <- np.hauls[c("Year", "Quarter", "PosAreaH")]
    np.rects <- np.rects[c("Year", "Quarter", "PosAreaR")]
    SPI <- SPI[c("Year", "Quarter", "SPI")]
    sa <- sa
    ea <- ea
    cog <- cog
    cha <- cha[c("Year", "Quarter", "areaoccupied")]
    ## merge
    si <- Reduce(function(x, y) merge(x, y, by = c("Year", "Quarter")), list(Gini.index, D95, np.hauls, np.rects, SPI, sa, ea, cog, cha))
    ## rename some columns
    si <- si %>%
      rename("Positive Area (Haul)" = PosAreaH,
             "Positive Area (Rectangle)" = PosAreaR,
             "CoG (x)" = cg_x,
             "CoG (y)" = cg_y, 
             "Inertia" = inertia,
             "Ellipse Area" = area_of_ellipse,
             "Convex Hull Area" = areaoccupied) %>%
      mutate(SurveyIndex = names(stk_data_filtered[indx]),
             Survey = names(stk_data_filtered[[indx]][survey]),
             StockID = stk.chr) %>%
      relocate(StockID, SurveyIndex, Survey, Year, Quarter, `Gini Index`) #, D95, `Positive Area (Haul)`, `Positive Area (Rectangle)`, SPI) these might also have to be ordered to match roc order
    # Gini must be the first spat ind column for the roc and tss funs
    
    
  ### Save
  ## Create directories
  if(dir.exists(paste0(si.output.path, stk.chr)) == FALSE){
    dir.create(paste0(si.output.path, stk.chr))
  }
  if(dir.exists(paste0(si.output.path, stk.chr, "/", names(stk_data_filtered[indx]))) == FALSE){
    dir.create(paste0(si.output.path, stk.chr, "/", names(stk_data_filtered[indx])))
  }
  if(dir.exists(paste0(si.output.path, stk.chr, "/", names(stk_data_filtered[indx]), "/", names(stk_data_filtered[[indx]][survey]))) == FALSE){
    dir.create(paste0(si.output.path, stk.chr, "/", names(stk_data_filtered[indx]), "/", names(stk_data_filtered[[indx]][survey])))
  }
    si.save.path <- paste0(si.output.path, stk.chr, "/", names(stk_data_filtered[indx]), "/", names(stk_data_filtered[[indx]][survey]))
    
  if(dir.exists(paste0(si.save.path, "/SpatIndData")) == FALSE){
    dir.create(paste0(si.save.path, "/SpatIndData"))
  }  
  save(si, file = paste0(si.save.path, "/SpatIndData/SpatIndData - ", stk.chr, " - ", names(stk_data_filtered[indx]), " - ", names(stk_data_filtered[[indx]][survey]), ".rda"))
  }
}
```
```{r}
  ### Plot
  message("Plotting spatial indictaor time series...")
  ## Create directory
  if(dir.exists(paste0(si.save.path, "/SpatIndPlot")) == FALSE){
    dir.create(paste0(si.save.path, "/SpatIndPlot"))
  } 
    ## convert data frame to long format
  si_scaled <- si %>%
    mutate("Spreading Area" = rescale(`Spreading Area`),
           "Equivalent Area" = rescale(`Equivalent Area`),
           "CoG (x)" = rescale(`CoG (x)`),
           "CoG (y)" = rescale(`CoG (y)`), 
           "Inertia" = rescale(Inertia),
           "Ellipse Area" = rescale(`Ellipse Area`),
           "Convex Hull Area" = rescale(`Convex Hull Area`))
  
    si_long <- si %>% tidyr::pivot_longer(cols = c("Gini Index", "D95", "Positive Area (Rectangle)", "Positive Area (Haul)", "SPI", "Spreading Area", "Equivalent Area", "CoG (x)","CoG (y)", "Inertia", "Ellipse Area", "Convex Hull Area", "SSB"), 
                            names_to = "Spatial Indicator",
                            values_to = "Spatial Indicator Value")
    si_long$`Spatial Indicator` <- factor(si_long$`Spatial Indicator`, levels = c("Gini Index", "D95", "Positive Area (Haul)", "Positive Area (Rectangle)", "SPI", "Spreading Area", "Equivalent Area", "CoG (x)","CoG (y)", "Inertia", "Ellipse Area", "Convex Hull Area", "SSB")) # factor & relocate
    qrs_text <- paste(as.character(sort(qrs)), collapse = ", ")
    group_colours <- c(`Gini Index` = 2, D95 = 3, `Positive Area (Haul)` = 4, `Positive Area (Rectangle)` = 5, SPI = 6, `Spreading Area` = 7, `Equivalent Area` = 8, `CoG (x)` = 9, `CoG (y)` = 10, Inertia = 11, `Ellipse Area` = 12, `Convex hull Area` = 13) # same colours as ROC and TSS
    

    si_facet_plot <- ggplot() + 
      geom_line(data = si_long, aes(x = Year, y = `Spatial Indicator Value`)) + 
      facet_wrap(vars(`Spatial Indicator`), scales = "free_y") +
      labs(title = paste0("Spatial Indicator Time Series for ", stk.chr),
           subtitle = paste0("Survey Index: ", names(stk_data_filtered[indx]), 
                             " | Survey: ", names(stk_data_filtered[[indx]][survey]), 
                             " (", min(yrs), "-", max(yrs), ", Q", qrs_text, ")")) +
      ylab("Indicator Value")
    s <- si_facet_plot + geom_line(data = si_long, aes(x = Year, y = `Spatial Indicator Value`))
    ## create the plot
    si_plot <- ggplot() +
      geom_line(data = si_long, aes(x = Year, 
                                    y = `Spatial Indicator Value`, 
                                    group = `Spatial Indicator`, 
                                    colour = `Spatial Indicator`), 
                key_glyph = "rect") +
      labs(title = paste0("Spatial Indicator Time Series for ", stk.chr),
           subtitle = paste0("Survey Index: ", names(stk_data_filtered[indx]), 
                             " | Survey: ", names(stk_data_filtered[[indx]][survey]), 
                             " (", min(yrs), "-", max(yrs), ", Q", qrs_text, ")")) +
      # Axes breaks
      #coord_cartesian(ylim = c(0,1)) +
      scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.1)) +
      scale_x_continuous(limits = c(min(si_long$Year), max(si_long$Year)), breaks = seq(min(si_long$Year), max(si_long$Year), 2), expand = c(0,0)) +
      # Theme
      theme(plot.title = element_text(size = 10, face = "bold"),
            plot.subtitle = element_text(size = 8),
            # Legend
            legend.title = element_text(size = 9),
            legend.text = element_text(size = 8),
            legend.background = element_blank(),
            legend.position = "right",
            legend.key = element_rect(colour="black", linewidth = 0.5), # border around glyphs
            legend.key.width = unit(0.3, "cm"),
            legend.key.height = unit(0.3, "cm"),
            legend.spacing.y = unit(0.2, "cm"), # distance between each key glyph
            # Axes
            axis.text = element_text(size = 8),
            axis.text.x = element_text(angle = 90, vjust = 0.3), # rotate & shift right
            axis.title = element_text(size = 10),
            # Panels
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.border = element_rect(colour = "black", fill = NA),
            panel.background = element_blank()) +
        guides(colour = guide_legend(byrow = TRUE)) # to enable vertical spacing between key glyphs
      #scale_colour_manual(values = group_colours, guide = "legend") # custom colours matching ROC colours

    si_plot
    
      ## save plot
    cowplot::save_plot(plot = si_plot, filename = paste0(si.save.path, "/SpatIndPlot/SpatIndPlot - ", stk.chr, " - ", names(stk_data_filtered[indx]), " - ", names(stk_data_filtered[[indx]][survey]), ".png"))
    print(noquote("-------------------------------"))
  }
}
```

## SDI Plot
```{r}
si.stk.path <- paste0("C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/10Stock_Outputs/")
StockFolder <- "ple.27.7d"
IndexFolder <- "UK-BTS"


# Get all SDI data and convert into long format
sdi_longlist <- list()
sdi_widelist <- list()
i <- 1
for(StockFolder in list.files(si.stk.path)){
  message(paste0("Stock: ", StockFolder))
  for(IndexFolder in list.files(paste0(si.stk.path, StockFolder))){
    message(paste0("Survey Index: ", IndexFolder))
    for(SurveyFolder in list.files(paste0(si.stk.path, StockFolder, "/", IndexFolder, "/"))){
      print(noquote(paste0("Survey: ", SurveyFolder)))
      
        # Load Spatial Indicator Data
        si_file <- list.files(paste0(si.stk.path, StockFolder, "/", IndexFolder, "/", SurveyFolder, "/SpatIndData/"), pattern = "*SpatIndData*")
        load(paste0(si.stk.path, StockFolder, "/", IndexFolder, "/", SurveyFolder, "/SpatIndData/", si_file))
        #si <- try(si %>% select(-`Equivalent Area (scaled)`, -`Spreading Area (scaled)`, -`SSB`))
        si$Inertia <- si$Inertia/1000000
        colnames(si)[colnames(si)=="Inertia"] <- "Inertia (million)"
        sdi_widelist[[i]] <- si
        # Convert wide to long
        si_long <- si %>% tidyr::pivot_longer(cols = c("Gini Index", "D95", "Positive Area (Rectangle)", "Positive Area (Haul)", "SPI", "Spreading Area", "Equivalent Area",
                                                       "CoG (x)","CoG (y)", "Inertia (million)", "Ellipse Area", "Convex Hull Area"), 
                          names_to = "Spatial Indicator",
                          values_to = "Spatial Indicator Value")
        si_long$`Spatial Indicator` <- factor(si_long$`Spatial Indicator`, levels = c("Gini Index", "D95", "Positive Area (Haul)", "Positive Area (Rectangle)", "SPI", 
                                                                                      "Spreading Area", "Equivalent Area", "CoG (x)","CoG (y)", "Inertia (million)", 
                                                                                      "Ellipse Area", "Convex Hull Area")) # factor & relocate
        sdi_longlist[[i]] <- si_long
        i <- i + 1
    }
  }
}
# Merge lists of data
sdiall_long <- do.call(rbind, sdi_longlist)
sdiall_wide <- do.call(rbind, sdi_widelist)
# Create new column for line plot
sdiall_long$`Survey Index, Survey Name` <- paste0(sdiall_long$SurveyIndex, ", ", sdiall_long$Survey)
sdiall_wide$`Survey Index, Survey Name` <- paste0(sdiall_wide$SurveyIndex, ", ", sdiall_wide$Survey)
```
```{r}
# Filter to stock of interest
stk.chr <- "ple.27.7d" # "cod.27.47d20_nov" "had.27.46a20" "ple.27.420" "ple.27.7d" "pok.27.3a46" "sol.27.4" "sol.27.7d" "tur.27.4" "whg.27.47d" "wit.27.3a47d"
stk <- ple.27.7d

sdistk_long <- filter(sdiall_long, StockID == stk.chr) 
sdistk_wide <- filter(sdiall_wide, StockID == stk.chr)

# Get SSB for survey years
strtyr <- min(sdistk_wide$Year)
endyr <- range(stk)["maxyear"]
stkssb <- as.data.frame(ssb(stk)[,ac(strtyr:endyr)])[c("year", "data")] %>%
  rename(Year = year, SSB = data) %>%
  mutate(type = "SSB")

# Plot SSB
ssb_plot <- ggplot() + geom_line(data = stkssb, aes(x = Year, y = SSB/1000000), colour = "black") +
  theme(panel.grid.major = element_line(colour = "grey90"),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      panel.border = element_rect(colour = "black", fill = NA),
      strip.background = element_rect(colour = "black", fill = "grey20"),
      strip.text = element_text(colour = "white", face = "bold"), 
      # Axis
      axis.text = element_text(size = 8),
      #axis.text.x = element_text(angle = 90, vjust = 0.3), # rotate & shift right
      axis.title = element_text(size = 10),
      aspect.ratio = 1) +
  ylab("SSB (million tons)") +
  facet_wrap(vars(`type`))

# Plot SDIs
sdi_plot1 <- ggplot() + 
  geom_line(data = sdistk_long, aes(x = Year, y = `Spatial Indicator Value`, colour = `Survey Index, Survey Name`), key_glyph = "rect") + 
  #geom_smooth(data = sdistk_long, aes(x = Year, y = `Spatial Indicator Value`, colour = `Survey Index, Survey Name`)) + 
  facet_wrap(vars(`Spatial Indicator`), scales = "free") +
  labs(title = paste0("Spatial Indicator Time Series (", stk.chr, ")"))+
  ylab("Indicator Value") + 
  # Theme
  theme(
    # Panels
    panel.grid.major = element_line(colour = "grey90"),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA),
    strip.background = element_rect(colour = "black"),
    # Legend
    #legend.justification = "top",
    legend.position = "right",
    legend.key = element_rect(colour="black", linewidth = 0.5), # border around glyphs
    legend.key.width = unit(0.3, "cm"),
    legend.key.height = unit(0.3, "cm"),
    legend.spacing.y = unit(0.3, "cm"), # distance between each key glyph
    #legend.position = c(1.164,.69),
    #legend.background = element_rect(colour = "black"),
    # Axis
    axis.text = element_text(size = 8),
    #axis.text.x = element_text(angle = 90, vjust = 0.3), # rotate & shift right
    axis.title = element_text(size = 10),
    aspect.ratio = 1,
    plot.margin = unit(c(0.5,2,0.5,0.5), "cm")
    ) +
  guides(colour = guide_legend(byrow = TRUE)) # to enable vertical spacing between key glyphs

# Overlay SSB plot SDI plot
sdissb_plot <- ggdraw()+ draw_plot(sdi_plot1)+ draw_plot(ssb_plot, x= .76, y= 0.2977, width=.206, height = .206)
# Save
cowplot::save_plot(plot = sdissb_plot, filename = paste0(si.stk.path, "SpatIndPlot-", stk.chr, ".png"), base_height = 25, base_width = 12)
```

## ROC Curve and TSS Plot
Now we use the spatial indicator times series data, along with the stock assessment data to calculate and plot the ROC curves and TSS. Again, this is done for each survey within each survey index.
```{r}
si.stk.path <- paste0("C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/10Stock_Outputs/", stk.chr, "/")

IndexFolder <- "IBTS Q1"
SurveyFolder <- "NS-IBTS"

for(IndexFolder in list.files(si.stk.path)){
  message(paste0("Survey Index: ", IndexFolder))
  for(SurveyFolder in list.files(paste0(si.stk.path, IndexFolder, "/"))){
    print(noquote(paste0("Survey: ", SurveyFolder)))
    
      # Load Spatial Indicator Data
      si_file <- list.files(paste0(si.stk.path, IndexFolder, "/", SurveyFolder, "/SpatIndData/"), pattern = "*SpatIndData*")
      load(paste0(si.stk.path, IndexFolder, "/", SurveyFolder, "/SpatIndData/", si_file))
      
      # Get survey years
      yrs <- si$Year
      print(noquote(paste0("Survey years: ", min(yrs), " to ", max(yrs))))
      
      # Get stock assessment reference points
      # Calculate SSB/MSY Btrigger
      msybtrig_refpt <- allstk_refpts$MSY_Btrigger[allstk_refpts$stk_name == stk.chr]
      ssb.msybtrig <- as.data.frame(ssb(stk)/msybtrig_refpt) %>%
        filter(year %in% yrs) %>%
        select(year, data) %>%
        rename(Year = year, SSB.MSYBtrigger = data)
      
      # !! for later...not yet used
      fmsy_refpt <- allstk_refpts$FMSY[allstk_refpts$stk_name == stk.chr]
      
      # Path location
      path.roc <- paste0(si.stk.path, IndexFolder, "/", SurveyFolder, "/ROC")
      
      # Create output directories
      if(dir.exists(path.roc) == FALSE){
        dir.create(path.roc)
      }
      if(dir.exists(paste0(path.roc, "/ROCcurve")) == FALSE){
        dir.create(paste0(path.roc, "/ROCcurve"))
      }
      if(dir.exists(paste0(path.roc, "/TSS")) == FALSE){
        dir.create(paste0(path.roc, "/TSS"))
      }
      
      # Plot and save ROC curves
      png(paste0(path.roc, "/ROCcurve/", stk.chr, " - ", IndexFolder, " - ", SurveyFolder, "ROC.png"), width = 900, height = 600)
      
      roc_group(SpatInds = si, 
            StatusInds = ssb.msybtrig, 
            stk_status = "SSB.MSYBtrigger",
            stk_name = stk.chr,
            species_name = species$spcs_name,
            survey_index = IndexFolder,
            survey_name = SurveyFolder)

  
      dev.off()
      
      # Plot and save TSS plot
      png(paste0(path.roc, "/TSS/", stk.chr, " - ", IndexFolder, " - ", SurveyFolder, "TSS.png"), width = 900, height = 600)
      
      tss_group2(SpatInds = si,
            StatusInds = ssb.msybtrig,
            stk_status = "SSB.MSYBtrigger",
            stk_name = stk.chr,
            species_name = species$spcs_name,
            survey_index = IndexFolder,
            survey_name = SurveyFolder)
            
      dev.off()

      rm(si)
  }
}
```

## Spatial Indicator Time Series with Optimum Threshold
```{r}
si.stk.path <- paste0("C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/10Stock_Outputs/", stk.chr, "/")

IndexFolder <- "IBTS Q1"
SurveyFolder <- "NS-IBTS"

for(IndexFolder in list.files(si.stk.path)){
  message(paste0("Survey Index: ", IndexFolder))
  for(SurveyFolder in list.files(paste0(si.stk.path, IndexFolder, "/"))){
    print(noquote(paste0("Survey: ", SurveyFolder)))
      # Load Spatial Indicator Data
      si_file <- list.files(paste0(si.stk.path, IndexFolder, "/", SurveyFolder, "/SpatIndData/"), pattern = "*SpatIndData*")
      load(paste0(si.stk.path, IndexFolder, "/", SurveyFolder, "/SpatIndData/", si_file))
      
      # Get survey years
      yrs <- si$Year
      qrs <- unique(si$Quarter)
      print(noquote(paste0("Survey years: ", min(yrs), " to ", max(yrs))))
      
      # Get stock assessment reference points
      # Calculate SSB/MSY Btrigger
      msybtrig_refpt <- allstk_refpts$MSY_Btrigger[allstk_refpts$stk_name == stk.chr]
      ssb.msybtrig <- as.data.frame(ssb(stk)/msybtrig_refpt) %>%
        filter(year %in% yrs) %>%
        select(year, data) %>%
        rename(Year = year, SSB.MSYBtrigger = data)
      
      # Path location
      path.spatopt <- paste0(si.stk.path, IndexFolder, "/", SurveyFolder, "/SpatIndPlot")
      # Create output directories
      if(dir.exists(path.spatopt) == FALSE){
        dir.create(path.spatopt)
      }
      
      # Calculate ROC and get optimum threshold for each spatial indicator
      spatindcols <- colnames(si[match("Gini Index", colnames(si)):length(colnames(si))])
      spatoptdf <- data.frame("Spatial.Indicator" = spatindcols, 
                              "OptThresh" = as.numeric(rep("NA", length(spatindcols))),
                              "OptTSS" = as.numeric(rep("NA", length(spatindcols))))
      stk_status = "SSB.MSYBtrigger"
      
      for(stk_index in colnames(si[match("Gini Index", colnames(si)):length(colnames(si))])){
        # Create dataset with all spatial indicators and true stock status
        all_data <- Reduce(function(x, y) merge(x, y, by = "Year"), list(si, ssb.msybtrig))
        
        all_data[ncol(all_data)+1] <- all_data[stk_index] # copies indicator to end column
        colnames(all_data)[ncol(all_data)] <- "ind" # changes name of end column
        all_data[ncol(all_data)+1] <- all_data[stk_status] # copies status to end column
        colnames(all_data)[ncol(all_data)] <- "state" # changes name of end column
      
        # Retrieve optimum threshold for each spatial indicator
        roc <- roc_fun2(all_data, state = state, ind = ind)
        opt_thresh_ind <- order(roc[,"TSS"],decreasing = T)[1]
        opt_thresh <- roc[opt_thresh_ind, "ind"]
        opt_tss <- roc[opt_thresh_ind, "TSS"]
        # Add to data frame
        spatoptdf$OptThresh[spatoptdf$Spatial.Indicator == stk_index] <- opt_thresh
        spatoptdf$OptTSS[spatoptdf$Spatial.Indicator == stk_index] <- opt_tss
      }
      
      # Convert si wide to long and add TSS to spatind names
      G <- paste0("Gini Index (", round(spatoptdf$OptTSS[spatoptdf$Spatial.Indicator == "Gini Index"], 2), ")")
      D <- paste0("D95 (", round(spatoptdf$OptTSS[spatoptdf$Spatial.Indicator == "D95"], 2), ")")
      PH <- paste0("Positive Area (Haul) (", round(spatoptdf$OptTSS[spatoptdf$Spatial.Indicator == "Positive Area (Haul)"], 2), ")")
      PR <- paste0("Positive Area (Rectangle) (",round(spatoptdf$OptTSS[spatoptdf$Spatial.Indicator == "Positive Area (Rectangle)"], 2), ")")
      S <- paste0("SPI (",round(spatoptdf$OptTSS[spatoptdf$Spatial.Indicator == "SPI"], 2), ")")
      
      spatoptdf$Spatial.Indicator <- factor(spatoptdf$Spatial.Indicator, 
                                            levels = c("Gini Index", 
                                                       "D95", 
                                                       "Positive Area (Haul)", 
                                                       "Positive Area (Rectangle)", 
                                                       "SPI"),
                                            labels = c(G,
                                                       D,
                                                       PH,
                                                       PR,
                                                       S))
      
      si_long <- si %>% tidyr::pivot_longer(cols = c("Gini Index", "D95", "Positive Area (Rectangle)", "Positive Area (Haul)", "SPI" ), 
                                  names_to = "Spatial Indicator (TSS)",
                                  values_to = "Spatial Indicator Value")
      si_long$`Spatial Indicator (TSS)` <- factor(si_long$`Spatial Indicator (TSS)`, 
                                            levels = c("Gini Index", 
                                                       "D95", 
                                                       "Positive Area (Haul)", 
                                                       "Positive Area (Rectangle)", 
                                                       "SPI"),
                                            labels = c(G,
                                                       D,
                                                       PH,
                                                       PR,
                                                       S))
      
      qrs_text <- paste(as.character(sort(qrs)), collapse = ", ")
      # Make colours same as ROC and TSS plots
      spat_colours <- setNames(c(2,3,4,5,6, 1), c(G, D, PH, PR, S, "SSB/MSY Btrigger")) 
      
      ## For plotting ssb time series
      # Get ssb/msy btrigger
      stkssb2 <- as.data.frame(ssb(stk)/msybtrig_refpt)
      stkssb <- stkssb2
      # Rescale from 0 to 1
      stkssb$data <- (stkssb$data-min(stkssb$data))/(max(stkssb$data)-min(stkssb$data))
      # Get new position of ssb/msybtrigger threshold for scaled data
      ssbthresh <- (1-min(stkssb2$data))/(max(stkssb2$data)-min(stkssb2$data)) 
      # Filter to the years of the survey data
      stkssb <- stkssb %>%
        filter(year %in% yrs)
      ## For plotting rectangle shadows
      # Identify which years the stock is 'healthy'
      posyrs <- stkssb$year[stkssb$data >= ssbthresh]
      # Group each consecutive series of healthy years
      posyrsgroup <- cumsum(c(1, abs(posyrs[-length(posyrs)] - posyrs[-1]) > 1))
      posyrsdf <- data.frame(posyrs, posyrsgroup)
      posyrsdf$posyrsgroup <- factor(posyrsdf$posyrsgroup)
      # Get min and max years for each consecutive series 
      xmin <- c()
      xmax <- c()
      ymin <- c()
      ymax <- c()
      
      for(g in posyrsdf$posyrsgroup){
        xmin <- c(xmin, min(posyrsdf$posyrs[posyrsdf$posyrsgroup==g]))
        xmax <- c(xmax, max(posyrsdf$posyrs[posyrsdf$posyrsgroup==g]))
        ymin <- c(ymin, -Inf)
        ymax <- c(ymax, Inf)
      }
      
      ## create the plot
      si_plot <- ggplot() +
      # Shadow rects
      geom_rect(data = posyrsdf, inherit.aes = F, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, group = posyrsgroup), fill = "lightgrey", alpha = 0.1) +
      # si line plot
      geom_line(data = si_long, aes(x = Year, 
                                    y = `Spatial Indicator Value`, 
                                    group = `Spatial Indicator (TSS)`, 
                                    colour = `Spatial Indicator (TSS)`),
                                    linewidth = 0.4,
                                    key_glyph = "rect") +
      # ssb line plot
      geom_line(data = stkssb, aes(x = year, y = data, colour = "SSB/MSY Btrigger"), lty = 1, linewidth = 0.4, alpha = 1, show.legend = TRUE) +
      # si opt thresh
      geom_hline(data = spatoptdf, aes(yintercept = OptThresh, group = `Spatial.Indicator`, colour = `Spatial.Indicator`), linetype = 2, alpha = 1, linewidth = 0.2) +
      labs(title = paste0("Spatial Indicator Time Series for ", stk.chr),
           subtitle = paste0("Survey Index: ", IndexFolder, 
                             " | Survey: ", SurveyFolder, 
                             " (", min(yrs), "-", max(yrs), ", Q", qrs_text, ")")) +
      # ssb thresh
      geom_hline(yintercept = ssbthresh, lty = 2, linewidth = 0.2, alpha = 0.5) +
      # Axes breaks
      #coord_cartesian(ylim = c(0,1)) +
      scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.1)) +
      scale_x_continuous(limits = c(min(si_long$Year), max(si_long$Year)), breaks = seq(min(si_long$Year), max(si_long$Year), 2), expand = c(0,0)) +
      # Theme
      theme(plot.title = element_text(size = 10, face = "bold"),
            plot.subtitle = element_text(size = 8),
            # Legend
            legend.title = element_text(size = 9),
            legend.text = element_text(size = 8),
            legend.background = element_blank(),
            legend.position = "right",
            legend.key = element_rect(colour="black", linewidth = 0.5), # border around glyphs
            legend.key.width = unit(0.3, "cm"),
            legend.key.height = unit(0.3, "cm"),
            legend.spacing.y = unit(0.2, "cm"), # distance between each key glyph
            # Axes
            axis.text = element_text(size = 8),
            axis.text.x = element_text(angle = 90, vjust = 0.3), # rotate & shift right
            axis.title = element_text(size = 10),
            # Panels
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.border = element_rect(colour = "black", fill = NA),
            panel.background = element_blank()) +
        guides(colour = guide_legend(byrow = TRUE)) + # to enable vertical spacing between key glyphs
      scale_colour_manual(values = spat_colours, guide = "legend") # custom colours matching ROC colours
  
      ## save plot
    cowplot::save_plot(plot = si_plot, filename = paste0(si.stk.path, IndexFolder, "/", SurveyFolder, "/SpatIndPlot/OptSpatIndPlot - ", stk.chr, " - ", IndexFolder, " - ", SurveyFolder, ".png"))
    print(noquote("-------------------------------"))
  }
}
```


## Store AUC and TSS values
```{r}
allsipaths <- "C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/10Stock_Outputs/"

auctss <- data.frame("Stock ID" = NA, "Survey Index" = NA, "Survey" = NA, "Years" = NA, "Quarter" = NA, "Spatial.Indicator" = NA, "TSS" = NA, "AUC" = NA)

for(StockFolder in list.files(allsipaths)){
  message(paste0("Stock Name: ", StockFolder))
  for(IndexFolder in list.files(paste0(allsipaths, StockFolder))){
    print(noquote(paste0("Survey Index: ", IndexFolder)))
    for(SurveyFolder in list.files(paste0(allsipaths, StockFolder, "/", IndexFolder))){
      print(noquote(paste0("   Survey Name: ", SurveyFolder)))
        # Load Spatial Indicator Data
        si_file <- list.files(paste0(allsipaths, StockFolder, "/", IndexFolder, "/", SurveyFolder, "/SpatIndData/"), pattern = "*SpatIndData*")
        load(paste0(allsipaths, StockFolder, "/", IndexFolder, "/", SurveyFolder, "/SpatIndData/", si_file))
        
        # Get survey years
        yrs <- si$Year
        qrs <- unique(si$Quarter)
        print(noquote(paste0("Survey years: ", min(yrs), " to ", max(yrs))))
        
        # Get stock assessment reference points
        # Calculate SSB/MSY Btrigger
        msybtrig_refpt <- allstk_refpts$MSY_Btrigger[allstk_refpts$stk_name == stk.chr]
        ssb.msybtrig <- as.data.frame(ssb(stk)/msybtrig_refpt) %>%
          filter(year %in% yrs) %>%
          select(year, data) %>%
          rename(Year = year, SSB.MSYBtrigger = data)
        
        # Path location
        path.spatopt <- paste0(allsipaths, StockFolder, "/", IndexFolder, "/", SurveyFolder, "/SpatIndPlot")
        # Create output directories
        if(dir.exists(path.spatopt) == FALSE){
          dir.create(path.spatopt)
        }
        
        # Calculate ROC and TSS and store outputs
        spatindcols <- colnames(si[match("Gini Index", colnames(si)):length(colnames(si))])
        outputs <- data.frame("Stock ID" = rep(StockFolder, length(spatindcols)),
                              "Survey Index" = rep(IndexFolder, length(spatindcols)),
                              "Survey" = rep(SurveyFolder, length(spatindcols)),
                              "Years" = rep(paste0(min(yrs), "-", max(yrs)), length(spatindcols)),
                              "Quarter" = rep(qrs, length(spatindcols)),
                              "Spatial.Indicator" = spatindcols, 
                              "TSS" = as.numeric(rep("NA", length(spatindcols))),
                              "AUC" = as.numeric(rep("NA", length(spatindcols))))
        stk_status = "SSB.MSYBtrigger"
        
        for(stk_index in colnames(si[match("Gini Index", colnames(si)):length(colnames(si))])){
          # Create dataset with all spatial indicators and true stock status
          all_data <- Reduce(function(x, y) merge(x, y, by = "Year"), list(si, ssb.msybtrig))
          
          all_data[ncol(all_data)+1] <- all_data[stk_index] # copies indicator to end column
          colnames(all_data)[ncol(all_data)] <- "ind" # changes name of end column
          all_data[ncol(all_data)+1] <- all_data[stk_status] # copies status to end column
          colnames(all_data)[ncol(all_data)] <- "state" # changes name of end column
        
          # Retrieve TSS for each spatial indicator
          roc <- roc_fun2(all_data, state = state, ind = ind)
          opt_thresh_ind <- order(roc[,"TSS"],decreasing = T)[1]
          opt_tss <- roc[opt_thresh_ind, "TSS"]
          # Get AUC
          x <- 1-roc$FPR
          y <- roc$TPR
          auc <- sum(diff(x)*rollmean(y,2))
          # Add to data frame
          outputs$TSS[outputs$Spatial.Indicator == stk_index] <- opt_tss
          outputs$AUC[outputs$Spatial.Indicator == stk_index] <- auc
        }
        auctss <- rbind(auctss, outputs)
    }
  }
}
auctss <- na.omit(auctss)
```

## Summary plots of AUC and TSS
```{r}
spat_colours <- setNames(c(2,3,4,5,6), c("Gini Index", "D95", "Positive Area (Haul)", "Positive Area (Rectangle)", "SPI")) 
```

### Total AUC across all surveys, for all stocks
```{r}
ggplot() +
  geom_col(data = auctss, aes(y = AUC, x = Spatial.Indicator, fill = Spatial.Indicator)) +
  guides(fill = guide_legend(byrow = TRUE)) + # to enable vertical spacing between key glyphs
  scale_fill_manual(values = spat_colours, guide = "legend") +
  # Theme
  theme(plot.title = element_text(size = 10, face = "bold"),
            plot.subtitle = element_text(size = 8),
            # Legend
            legend.title = element_text(size = 9),
            legend.text = element_text(size = 8),
            legend.background = element_blank(),
            legend.position = "right",
            legend.key = element_rect(colour="black", linewidth = 0.5), # border around glyphs
            legend.key.width = unit(0.3, "cm"),
            legend.key.height = unit(0.3, "cm"),
            legend.spacing.y = unit(0.2, "cm"), # distance between each key glyph
            # Axes
            #axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.ticks.x = element_blank(),
            # Panels
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.border = element_rect(colour = "black", fill = NA),
            panel.background = element_rect(fill = "grey95")) +
  labs(title = "Spatial indicator AUC across all surveys and stocks", 
       x = "Spatial Indicator", 
       y = "Area Under Curve (AUC)",
       fill = "Spatial Indicator")
```

### Total TSS across all surveys, for all stocks
```{r}
ggplot() +
  geom_col(data = auctss, aes(y = TSS, x = Spatial.Indicator, fill = Spatial.Indicator)) +
  guides(fill = guide_legend(byrow = TRUE)) + # to enable vertical spacing between key glyphs
  scale_fill_manual(values = spat_colours, guide = "legend") +
  # Theme
  theme(plot.title = element_text(size = 10, face = "bold"),
            plot.subtitle = element_text(size = 8),
            # Legend
            legend.title = element_text(size = 9),
            legend.text = element_text(size = 8),
            legend.background = element_blank(),
            legend.position = "right",
            legend.key = element_rect(colour="black", linewidth = 0.5), # border around glyphs
            legend.key.width = unit(0.3, "cm"),
            legend.key.height = unit(0.3, "cm"),
            legend.spacing.y = unit(0.2, "cm"), # distance between each key glyph
            # Axes
            #axis.text = element_blank(),
            axis.text.x = element_blank(),
            axis.ticks.x = element_blank(),
            # Panels
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.border = element_rect(colour = "black", fill = NA),
            panel.background = element_rect(fill = "grey95")) +
  labs(title = "Spatial indicator TSS across all surveys and stocks", 
       x = "Spatial Indicator", 
       y = "True Skill Score (TSS)",
       fill = "Spatial Indicator")

```

### Total AUC for each survey within each index, for all stocks
```{r}
for(stock in unique(auctss$Stock.ID)){
  auctss_spcs <- auctss %>%
    filter(Stock.ID == stock)
  
  sumaucplot <- ggplot() +
    geom_col(data = auctss_spcs, aes(y = AUC, x = Spatial.Indicator, fill = Spatial.Indicator), colour = "black") +
    guides(fill = guide_legend(byrow = TRUE)) + # to enable vertical spacing between key glyphs
    scale_fill_manual(values = spat_colours, guide = "legend") + # custom colours matching ROC colours
    facet_wrap(vars(Survey.Index, Survey)) +
    #facet_grid(Stock.ID ~ Survey) +
    scale_y_continuous(limits = c(0,1)) +
    # Theme
    theme(plot.title = element_text(size = 10, face = "bold"),
              plot.subtitle = element_text(size = 8),
              # Legend
              legend.title = element_text(size = 9),
              legend.text = element_text(size = 8),
              legend.background = element_blank(),
              legend.position = "right",
              #legend.key = element_rect(colour="black", linewidth = 0.5), # border around glyphs
              legend.key.width = unit(0.3, "cm"),
              legend.key.height = unit(0.3, "cm"),
              legend.spacing.y = unit(0.2, "cm"), # distance between each key glyph
              # Axes
              #axis.text = element_blank(),
              axis.text.x = element_blank(),
              axis.title.x = element_blank(),
              axis.ticks.x = element_blank(),
              # Panels
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              panel.border = element_rect(colour = "black", fill = NA),
              panel.background = element_rect(fill = "grey95"),
              # Facet grid customisation
              strip.background = element_rect(fill = "lightgrey", colour = "black")) +
    labs(fill = "Spatial Indicator", title = paste0("AUC of spatial indicators across surveys (", stock, ")"))
  
  cowplot::save_plot(plot = sumaucplot, filename = paste0("C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/10Stock_Outputs/", stock, "/", "sumAUC-", stock, ".png"))
}
```

### Total TSS for each survey within each index, for all stocks
```{r}
for(stock in unique(auctss$Stock.ID)){
  auctss_spcs <- auctss %>%
    filter(Stock.ID == stock)
  
  sumtssplot <- ggplot() +
    geom_col(data = auctss_spcs, aes(y = TSS, x = Spatial.Indicator, fill = Spatial.Indicator), colour = "black") +
    guides(fill = guide_legend(byrow = TRUE)) + # to enable vertical spacing between key glyphs
    scale_fill_manual(values = spat_colours, guide = "legend") + # custom colours matching ROC colours
    facet_wrap(vars(Survey.Index, Survey)) +
    #facet_grid(Stock.ID ~ Survey) +
    scale_y_continuous(limits = c(-1,1)) +
    # Theme
    theme(plot.title = element_text(size = 10, face = "bold"),
              plot.subtitle = element_text(size = 8),
              # Legend
              legend.title = element_text(size = 9),
              legend.text = element_text(size = 8),
              legend.background = element_blank(),
              legend.position = "right",
              #legend.key = element_rect(colour="black", linewidth = 0.5), # border around glyphs
              legend.key.width = unit(0.3, "cm"),
              legend.key.height = unit(0.3, "cm"),
              legend.spacing.y = unit(0.2, "cm"), # distance between each key glyph
              # Axes
              #axis.text = element_blank(),
              axis.text.x = element_blank(),
              axis.title.x = element_blank(),
              axis.ticks.x = element_blank(),
              # Panels
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              panel.border = element_rect(colour = "black", fill = NA),
              panel.background = element_rect(fill = "grey95"),
              # Facet grid customisation
              strip.background = element_rect(fill = "lightgrey", colour = "black")) +
    labs(fill = "Spatial Indicator", title = paste0("TSS of spatial indicators across surveys (", stock, ")"))
  
  cowplot::save_plot(plot = sumtssplot, filename = paste0("C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/10Stock_Outputs/", stock, "/", "sumTSS-", stock, ".png"))
}
```


