---
title: "ESIA for 10 Data Rich Stocks"
author: "Peter Kidd"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    toc: true
    toc_float: true
    toc_collapsed: false
    number_section: true
    theme: journal
    highlight: zenburn
    df_print: paged
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, echo = TRUE, fig.align = "center", fig.width = 6, comment = ">", cache = F)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Prepare Workspace
```{r wd}
# rm(list = ls())
getwd()

getOption("download.file.method") # if wininet, change to auto 
options(download.file.method = "curl")
```

# Load packages
```{r load.packages, message = FALSE}
### load packages
pckgs <- c("FLCore", "FLBRP", "dplyr", "ggplot2", "ggplotFL", "rgdal", "DataExplorer", "rgeos", "sf", "mapplots", "maptools", "mapproj", "beepr", "patchwork", "ineq", "icesDatras", "icesVocab", "scales", "readxl", "data.table", "zoo")

for(pkg in pckgs){
  library(pkg, character.only = T, quietly = T)
}

rm(pckgs, pkg)
```


# Source user functions
```{r funs, cache = F}
source(paste0(getwd(), "/Functions/dataprep_funs.R")) # for dealing with datras data
source(paste0(getwd(), "/Functions/spatinds_funs.R")) # for computing spatial indicators
```

# Load in Data
## ICES Divisions and Rectangles 
```{r ices.rect, cache = T}
### ICES Rectangles
ices_rect2 <- readOGR(dsn = paste0(getwd(), "/Data/ICES Rect"), layer = "StatRec_map_Areas_Full_20170124")
ices_rect <- makeReadableFortify(ices_rect2)

rm(ices_rect2)

### ICES Divisions
ices_divs2 <- readOGR(dsn = paste0(getwd(), "/Data/ICES Divs"), layer = "ICES_Areas_20160601_cut_dense_3857")
# ices_divs <- readOGR(dsn = "ICES North Sea Divisions", layer = "ICES_Divisons_CodHadWhgPok") # old shapefile
ices_divs <- makeReadableFortify(ices_divs2)

rm(ices_divs2)
```

### Plot Divisions
```{r}
### Check that divisions and rectangles look appropriate
ggplot() +
    geom_path(data = ices_divs, mapping = aes(x = long, y = lat, group = group), colour = "black") +
    geom_tile(data = ices_rect, mapping = aes(x = stat_x, y = stat_y, fill = Area_27)) +
    #geom_path(data = ices_divs, mapping = aes(x = long, y = lat, group = group), colour = "black") +
    #coord_cartesian(xlim = c(-50, 50), ylim = c(30,65), expand = F) +
    # World map
    borders("world", fill = "grey", colour = "black")
```


## Survey Data
Load in the survey data previously downloaded and processed in `1_Download_Survey_Data.Rmd`. These files are too large to upload to GitHub, so run the code and save to local drive. Change `surveydata.path` to the file locations: 
```{r}
surveydata.path <- "C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/Survey Data/"

# We don't need to load these in for now
load(paste0(surveydata.path, "NS-IBTS/ns_ibts.data.rda"))   # NS-IBTS
load(paste0(surveydata.path, "BTS/bts.data.rda"))           # BTS
load(paste0(surveydata.path, "BTS-Isis/bts_isis.data.rda")) # BTS-Isis
load(paste0(surveydata.path, "UK-BTS/uk_bts.data.rda"))     # UK-BTS
load(paste0(surveydata.path, "DYFS/dyfs.data.rda"))         # DYFS
load(paste0(surveydata.path, "FR-CGFS/fr_cgfs.data.rda"))   # FR-CGFS
load(paste0(surveydata.path, "IE-IGFS/ie_igfs.data.rda"))   # IE-IGFS
load(paste0(surveydata.path, "SCOWCGFS/scowcgfs.data.rda")) # SCOWCGFS
load(paste0(surveydata.path, "SNS/sns.data.rda"))           # SNS
load(paste0(surveydata.path, "SWC-IBTS/swc_ibts.data.rda")) # SWC-IBTS
```

## Stock Objects
Load in the stock assessment objects:
```{r}
stockobj.path <- paste0(getwd(), "/Data/DR_Stocks/Stock_Objects/")

for(stockfile in list.files(stockobj.path)){
  load(paste0(stockobj.path, stockfile))
}
```

## Stock Metadata and Reference Points
I have manually taken information from the advice sheets and put it into a Excel document
```{r}
allstk_metadata <- read_excel(paste0(getwd(), "/Data/DR_Stocks/Advice_Sheets/stock_metadata_refpts.xlsx"), sheet = "stk_metadata")

allstk_refpts <- read_excel(paste0(getwd(), "/Data/DR_Stocks/Advice_Sheets/stock_metadata_refpts.xlsx"), sheet = "stk_refpts")
```

# Run
## Set Parameters
### Choose Stock
Change `stk` and `stk.chr` to the stock you want to run the ROC analysis for.
```{r set.stock}
### Stocks available
unique(allstk_metadata$stk_id) # ignore so.27.7d for now, need to find YFS survey data
### Select the stock to analyse
stk <- wit.27.3a47d
stk.chr <- "wit.27.3a47d"
```

### Species Name
```{r get.spcsname}
### Get the stock species name
species <- allstk_refpts %>% filter(
  stk_name == stk.chr) %>%
  select(spcs_name, latin_name)
head(species)

### Get Valid Aphia ID using Latin name
species_aphia <- findAphia(species$latin_name, latin = TRUE)
```

### Stock Divisions
```{r get.stkdivs}
### Get the ICES divisions for the stock of interest
stk_divs2 <- allstk_metadata %>% filter(
  stk_id == stk.chr) %>%
  select(stk_divs) %>%
  unique()
stk_divs <- strsplit(as.character(stk_divs2), split = ", ")[[1]]
rm(stk_divs2)

print(paste0("ICES Divisions for ", species$spcs_name, " (", stk.chr, ") :"))
print(stk_divs)
```


### Stock Reference Points
```{r get.stkrefpts}
### Get the advice sheet reference points for the stock
stk_refpts <- allstk_refpts %>% filter(
  stk_name == stk.chr)
print(stk_refpts)
```

### Survey Information
These are the surveys that were used in the most recent assessment and mentioned on the ICES advice sheets for the corresponding stock. Most stocks have more than survey index incorperated within the stock assessment. Each individual survey index can also use multiple sources of survey data. E.g. a Q3 survey index might use and combine data from NS-IBTS Q3 and BTS Q3.
```{r get.surveyinfo}
# get survey information for the current stock we are looking at
stk_surveys <- allstk_metadata %>% filter(
  stk_id == stk.chr) %>%
  select(-description, -date_published)
print(stk_surveys)
```

There are many survey indices used, each using survey data from different year ranges and different quarters. In the spatial indicator analysis we will try to use the exact same range of survey data that was used in the stock assessments for each stock. This will ensure that the survey data used in the spatial analysis matches the data used in the stock assessment.
```{r}
### Select the surveys used within the stock assessment
## we will load in the survey data from local drive 
surveydata.path <- "C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/Survey Data/"

## Load the survey data used in the stock assessment for the current stock we are looking at
## Store in a list so we can loop through it later
## e.g. for Witch, BTS and NS-IBTS survey data were used. We store all this survey data into a list.
## we will filter this survey data to the correct years and quarters for each survey index later
## e.g. witch has 3 survey indices, BTS Q3, IBTS Q1, IBTS Q3, with different year ranges
data.list <- list()
for(survey in unique(stk_surveys$survey_name)){
  survey_data <- list.files(paste0(surveydata.path, survey), pattern = "*.data.rds*")
  survey_data <- try(load(paste0(surveydata.path, survey, "/", survey_data)))
  survey_data <- try(get(survey_data))
  data.list[[survey]] <- survey_data
}

### Check that surveys loaded are what we expect
summary(data.list)
unique(stk_surveys$survey_name)
```
Each survey within `data.list` contains the `hh`, `hl`, `ca` and combined `hlhh` data that was constructed in the data processing used `prepsurveydata`. We will mostly be working with the `hlhh` data but the rest is there for convenience.


Some surveys are combined to form one index as previously mentioned (e.g. IBTS Q3 and BTS Q3 might be combined to form a Q3 Survey Index)
```{r}
### Get the name of the individual indexes used in the stock assessment
### Each index can be comprised of multiple survey data sources 
# Get the name of the survey indices used in the stock assessment:
stk_surveys_indices <- allstk_metadata %>% filter(
  stk_id == stk.chr) %>%
  select(survey_index) %>%
  unique()
print(stk_surveys_indices)
```
We will now filter the survey data in accordance to the data used within each survey index. Sometimes the exact date ranges of survey data is not given in the stock assessment advice sheets. I have made the assumption that where the end year of the survey data used is not given, data up to the most recent data is used. Similarly, if the start year of survey data used is not given, data is used from the beginning of the survey data time series i.e. when the survey began. This latter assumption will need to be double checked as often older survey data is omitted due to differences in sampling effort or design compared to the most recent data.
```{r}
### Get the survey data used in each index and filter it so that it matches
### the data used in the stock assessment e.g. by Species, Years, and Quarters. 
stk_data_filtered <- list()
for(indx in stk_surveys_indices$survey_index){
  # for each survey index in the stock assessment...
  print(paste0("Survey Index: ", indx))
  # get the row of data in allstk_metadata for this survey index
  stkindx_surveys <- allstk_metadata %>%
  filter(stk_id == stk.chr,
         survey_index == indx)
  print(stkindx_surveys)
  #stk_data_filtered[indx] <- indx
  
  for(survey in stkindx_surveys$survey_name){
    print(paste0("Survey: ", survey))
    # for each survey within each survey index...
    # get the start and end years of the survey data used
    yr_strt <- stkindx_surveys$survey_yrs_start[stkindx_surveys$survey_name==survey]
    yr_end <- stkindx_surveys$survey_yrs_end[stkindx_surveys$survey_name==survey] 
    # assumptions made if start or end year is not given in the stock assessment
    if(is.na(yr_end)==TRUE){yr_end <- 2022} # assume most recent data used
    if(is.na(yr_strt)==TRUE){yr_strt <- 1900} # assume oldest data used
    # get the quarters used in stock stock index for this survey
    qrs <- stkindx_surveys$survey_qrs[stkindx_surveys$survey_name==survey]

    # sometimes the quarters used is not available in the advice sheets, so 
    # assume all quarters were used. This isn't explicitly stated probably because some 
    # surveys are only run in certain quarters so there is no need to say.
    # Setting `qrs` to c(1:4) will retain whatever data the survey has. 
    if(is.na(qrs)){
      qrs <- c(1:4)
    }
    
    # filter the years and quarters of survey data, for each survey, within each survey index
    # CHECK: do I need to do c(qrs). Will this code work if there are multiple quartes that need to be selected
    hlhh <- try(data.list[[survey]]$hlhh %>%
      filter(Year %in% c(yr_strt:yr_end),
             Quarter %in% qrs)) 
    hl <- try(data.list[[survey]]$hl %>%
      filter(Year %in% c(yr_strt:yr_end),
             Quarter %in% qrs))
    hh <- try(data.list[[survey]]$hh %>%
      filter(Year %in% c(yr_strt:yr_end),
             Quarter %in% qrs))
    ca <- try(data.list[[survey]]$ca %>%
      filter(Year %in% c(yr_strt:yr_end),
             Quarter %in% qrs))
    
    stk_data_filtered[[indx]][[survey]] <- list(hlhh = hlhh, hl = hl, hh = hh, ca = ca)
  }
}

### Check survey indices are what we expected
## These should match
summary(stk_data_filtered)
stk_surveys_indices$survey_index
## Check the years and quarters match

# for index 1, survey 1
# are the start and end years the same?
## will give NA is missing from stk_surveys
unique(stk_data_filtered[[1]][[1]]$hlhh$Year)
min(stk_data_filtered[[1]][[1]]$hlhh$Year)==stk_surveys$survey_yrs_start[1]
max(stk_data_filtered[[1]][[1]]$hlhh$Year)==stk_surveys$survey_yrs_end[1]

unique(stk_data_filtered[[1]][[1]]$hlhh$Quarter)
unique(stk_data_filtered[[1]][[1]]$hlhh$Quarter) == stk_surveys$survey_qrs[1]
```

Check that data was handled and filtered correctly
```{r data.check, eval = F}
# This is for plaice only
### Check that data was handled correctly
#### BTS+IBTS Q3 index, BTS survey
unique(stk_data_filtered$`BTS+IBTS Q3`$BTS$hlhh$Year)
unique(stk_data_filtered$`BTS+IBTS Q3`$BTS$hlhh$Quarter)
#### Check match up with stk_survey data
stk_surveys %>%
  filter(survey_index == "BTS+IBTS Q3",
         survey_name == "BTS") %>%
  select(survey_index, survey_name, survey_yrs_start, survey_yrs_end, survey_qrs)


#### BTS+IBTS Q3 index, NS-IBTS survey
unique(stk_data_filtered$`BTS+IBTS Q3`$`NS-IBTS`$hlhh$Year)
unique(stk_data_filtered$`BTS+IBTS Q3`$`NS-IBTS`$hlhh$Quarter)
#### Check match up with stk_survey data
stk_surveys %>%
  filter(survey_index == "BTS+IBTS Q3",
         survey_name == "NS-IBTS") %>%
  select(survey_index, survey_name, survey_yrs_start, survey_yrs_end, survey_qrs)


#### BTS-Isis index, BTS survey
unique(stk_data_filtered$`BTS-Isis`$`BTS-Isis`$hlhh$Year)
unique(stk_data_filtered$`BTS-Isis`$`BTS-Isis`$hlhh$Quarter)
#### Check match up with stk_survey data
stk_surveys %>%
  filter(survey_index == "BTS-Isis",
         survey_name == "BTS-Isis") %>%
  select(survey_index, survey_name, survey_yrs_start, survey_yrs_end, survey_qrs)


#### SNS1 index, SNS survey
unique(stk_data_filtered$`SNS1`$`SNS`$hlhh$Year)
unique(stk_data_filtered$`SNS1`$`SNS`$hlhh$Quarter)
#### Check match up with stk_survey data
stk_surveys %>%
  filter(survey_index == "SNS1",
         survey_name == "SNS") %>%
  select(survey_index, survey_name, survey_yrs_start, survey_yrs_end, survey_qrs)


#### SNS2 index, SNS survey
unique(stk_data_filtered$`SNS2`$`SNS`$hlhh$Year)
unique(stk_data_filtered$`SNS2`$`SNS`$hlhh$Quarter)
#### Check match up with stk_survey data
stk_surveys %>%
  filter(survey_index == "SNS2",
         survey_name == "SNS") %>%
  select(survey_index, survey_name, survey_yrs_start, survey_yrs_end, survey_qrs)
```

## Calculate Spatial Indicators
For each stock I will need to calculate spatial indicators for each survey index used in the stock assessment. Some survey indices combine multiple sources of survey data e.g. `IBTS+BTS Q3`

Check previously set parameters
```{r}
species$spcs_name
species_aphia
stk_divs
```


```{r}
si.output.path <- "C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/10Stock_Outputs/"

#1:length(stk_data_filtered)
for(i in 1:length(stk_data_filtered)){
  indx <- stk_data_filtered[i] # for each survey index
  message(paste0("Survey Index: ", names(indx)))
  for(j in 1:length(indx)){
    survy <- indx[[j]]        # for each survey within each survey index
    for(w in 1:length(survy)){
      message(paste0("Survey: ", names(survy[w])))
      print(survy[[w]])
      hlhh <- survy[[w]]$hlhh # get hlhh data for each survey within each index
      hh <- survy[[w]]$hh
      yrs <- unique(hlhh$Year)
      qrs <- unique(hlhh$Quarter)
      print(paste0("Survey years: ", min(yrs), "-", max(yrs)))
      print(paste0("Survey quarters: ", qrs))
################################################################################
### Calculate spatial indicators for each survey
      message("Calculating spatial indicators")
      ### Positive Area (by ICES rectangle)
      print("Positive Area (Rectangle)")
      np.rects <- pa_rect(hh = hh, 
              hlhh = hlhh, 
              yrs = yrs, 
              qrs = qrs, 
              species_aphia = species_aphia, 
              stk_regions = stk_divs)
      
      ### Positive Area (by Haul)
      print("Positive Area (Haul)")
      np.hauls <- pa_haul(hh = hh, 
              hlhh = hlhh, 
              yrs = yrs, 
              qrs = qrs, 
              species_aphia = species_aphia, 
              stk_regions = stk_divs)
      
      ### Lorenz curve data
      print("Lorenz Curve")
      lorenz <- lorenz_data(hlhh = hlhh, 
              yrs = yrs, 
              qrs = qrs, 
              species_aphia = species_aphia, 
              stk_regions = stk_divs)
      #### Gini index
      print("Gini Index")
      Gini.index <- Gini(lorenz)
      ##### Take inverse of Gini, so high numbers = good
      Gini.index$G <- 1- Gini.index$G
      #### D95
      print("D95")
      D95 <- d95(lorenz)
      
      ### Spread of Participation Index (SPI)
      #### Prep data
      print("Sprea of Participation Index")
      spi_data <- spi_prep(hlhh = hlhh, 
              yrs = yrs, 
              qrs = qrs, 
              species_aphia = species_aphia, 
              stk_regions = stk_divs)
      #### Calculate
      spi <- spi_data %>% group_by(Year) %>% # Year only, not quarter
        filter(Area_27 %in% stk_divs) %>%
        summarise(SPI = spi_calc(TotalNo_TotalDur, area = 1)) ## all areas equal weight
      #### Take inverse of SPI, so high numbers = good
      spi$SPI <- 1-spi$SPI 
################################################################################
      # Merge all spatial indicator values into a single data frame
      message("Merging and saving spatial indicator data")
      Gini.index <- Gini.index[c("Year", "G")]
      D95 <- D95[c("Year", "D95")]
      np.hauls <- np.hauls[c("Year", "PosArea")]
      np.rects <- np.rects[c("Year", "PosArea")]
      spi <- spi[c("Year", "SPI")]
      
      si <- Reduce(function(x, y) merge(x, y, by = "Year"), list(Gini.index, D95, np.hauls, np.rects, spi))
      
      colnames(si)[2] <- "Gini Index"
      colnames(si)[4] <- "Positve Area (Rectangle)"
      colnames(si)[5] <- "Positive Area (Haul)"
      


# Create directory
    if(dir.exists(paste0(si.output.path, stk.chr)) == FALSE){
      dir.create(paste0(si.output.path, stk.chr))
    }
    if(dir.exists(paste0(si.output.path, stk.chr, "/", names(indx))) == FALSE){
      dir.create(paste0(si.output.path, stk.chr, "/", names(indx)))
    }
    if(dir.exists(paste0(si.output.path, stk.chr, "/", names(indx), "/", names(survy[w]))) == FALSE){
      dir.create(paste0(si.output.path, stk.chr, "/", names(indx), "/", names(survy[w])))
    }
      si.save.path <- paste0(si.output.path, stk.chr, "/", names(indx), "/", names(survy[w]))
      
    if(dir.exists(paste0(si.save.path, "/SpatIndData")) == FALSE){
      dir.create(paste0(si.save.path, "/SpatIndData"))
    }  
      
      
    save(si, file = paste0(si.save.path, "/SpatIndData/SpatIndData - ", stk.chr, " - ", names(indx), " - ", names(survy[w]), ".rda"))
 
################################################################################
      ### Plot
    message("Plotting spatial indictaor time series")
      #### Create directory
    if(dir.exists(paste0(si.save.path, "/SpatIndPlot")) == FALSE){
      dir.create(paste0(si.save.path, "/SpatIndPlot"))
    } 
      #### convert data frame to long format
      si_long <- si %>% tidyr::pivot_longer(cols = c("Gini Index", "D95", "Positve Area (Rectangle)", "Positive Area (Haul)", "SPI" ), 
                              names_to = "Indicator",
                              values_to = "Value")
      #### create the plot
      si_plot <- ggplot() +
        geom_line(data = si_long, aes(x = Year, y = Value, group = Indicator, colour = Indicator)) +
        labs(title = paste0("Spatial Indicators for ", stk.chr,
" | Survey Index: ", names(indx), " | Survey: ", names(survy[w]), " (", min(yrs), "-", max(yrs), ", Q", qrs, ")")) +
        theme(plot.title = element_text(size = 8)) +
        coord_cartesian(ylim = c(0,1))
      ### save plot
      cowplot::save_plot(plot = si_plot, filename = paste0(si.save.path, "/SpatIndPlot/SpatIndPlot - ", stk.chr, " - ", names(indx), " - ", names(survy[w]), ".png"))
      
    }
  }
}
```

## ROC Curve and TSS Plot
```{r}
si.stk.path <- paste0("C:/Users/pk02/OneDrive - CEFAS/Projects/C8503B/PhD/DATRAS/Spatial Indicator R Project/10Stock_Outputs/", stk.chr, "/")

for(IndexFolder in list.files(si.stk.path)){
  print(paste0("Survey Index: ", IndexFolder))
  for(SurveyFolder in list.files(paste0(si.stk.path, IndexFolder, "/"))){
    print(paste0("Survey: ", SurveyFolder))
    
      # Load Spatial Indicator Data
      si_file <- list.files(paste0(si.stk.path, IndexFolder, "/", SurveyFolder, "/SpatIndData/"), pattern = "*SpatIndData*")
      load(paste0(si.stk.path, IndexFolder, "/", SurveyFolder, "/SpatIndData/", si_file))
      
      # Get stock assessment reference points
      yrs <- si$Year
      print(paste0(SurveyFolder, " survey years included in ", IndexFolder, " survey abundance index for ", stk.chr, ": ", min(yrs), " to ", max(yrs)))
      
      ## SSB/MSY Btrigger
      msybtrig_refpt <- allstk_refpts$MSY_Btrigger[allstk_refpts$stk_name == stk.chr]
      ssb.msybtrig <- as.data.frame(ssb(stk)/msybtrig_refpt) %>%
        filter(year %in% yrs) %>%
        select(year, data) %>%
        rename(Year = year, SSB.MSYBtrigger = data)
      
      fmsy_refpt <- allstk_refpts$FMSY[allstk_refpts$stk_name == stk.chr]
      
      # Path location
      path.roc <- paste0(si.stk.path, IndexFolder, "/", SurveyFolder, "/ROC")
      
      # Create output directories
      if(dir.exists(path.roc) == FALSE){
        dir.create(path.roc)
      }
      if(dir.exists(paste0(path.roc, "/ROCcurve")) == FALSE){
        dir.create(paste0(path.roc, "/ROCcurve"))
      }
      if(dir.exists(paste0(path.roc, "/TSS")) == FALSE){
        dir.create(paste0(path.roc, "/TSS"))
      }
      
      # Plot and save ROC curves
      png(paste0(path.roc, "/ROCcurve/", stk.chr, " - ", IndexFolder, " - ", SurveyFolder, "ROC.png"), width = 900, height = 600)
      
      roc_group(SpatInds = si, 
            StatusInds = ssb.msybtrig, 
            stk_status = "SSB.MSYBtrigger",
            stk_name = stk.chr,
            species_name = species$spcs_name)
  
      dev.off()
      
      # Plot and save TSS plot
      png(paste0(path.roc, "/TSS/", stk.chr, " - ", IndexFolder, " - ", SurveyFolder, "TSS.png"), width = 900, height = 600)
      
      tss_group(SpatInds = si,
                StatusInds = ssb.msybtrig,
                stk_status = "SSB.MSYBtrigger",
                stk_name = stk.chr,
                species_name = species$spcs_name)
            
      dev.off()

      rm(si)
  }
}
```
## Dev
```{r}
 ### Lorenz curve data
      print("Lorenz Curve")
      lorenz <- lorenz_data(hlhh = hlhh, 
              yrs = yrs, 
              qrs = qrs, 
              species_aphia = species_aphia, 
              stk_regions = stk_divs)
      #### Gini index
      print("Gini Index")
      Gini.index <- Gini(lorenz)
      ##### Take inverse of Gini, so high numbers = good
      Gini.index$G <- 1- Gini.index$G
      #### D95
      print("D95")
      D95 <- d95(lorenz)
```

